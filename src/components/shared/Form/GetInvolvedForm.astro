---
// GetInvolvedForm.astro - Newsletter/Get Involved Form Component
import './GetInvolvedForm.css';
import { t } from '../../../i18n/get';
import { Image } from 'astro:assets';

//Phosphor icons
import Chat from 'phosphor-astro/Chat.astro';
import SpeakerHigh from 'phosphor-astro/SpeakerHigh.astro';
import Hand from 'phosphor-astro/Hand.astro';
import ContactImage from '../../../assets/images/contact/getInvolved.jpg';

export interface Props {
  class?: string;
  lang?: 'en' | 'es';
}

const { class: className = '', lang = 'en' } = Astro.props as Props;
const url = Astro.url.href;
const urlSuffix = url.split('/').pop();
---

<div class="get-involved-container">
  <!-- Success Banner -->
  <div id="success-banner" class="banner banner-success" style="display: none;">
    <div class="banner-icon">✓</div>
    <div class="banner-content">
      <span class="banner-text">{t(lang, 'form.successMessage')}</span>
    </div>
  </div>

  <!-- Error Banner -->
  <div id="error-banner" class="banner banner-error" style="display: none;">
    <div class="banner-icon">✕</div>
    <div class="banner-content">
      <span class="banner-text" id="error-message"
        >{t(lang, 'form.errorMessage')}</span
      >
    </div>
  </div>

  <!-- Form and Image -->
  <div class="flex-container">
    <div class={`contact-form ${className}`}>
      <div class="form-header">
        <mdc-text type="body-large-regular" tagname="p" class="form-subtitle">
          {t(lang, 'form.subtitle')}
        </mdc-text>
      </div>

      <div class="contact-list">
        <ul>
          <li>
            <div class="get-invovled-icon"><Hand /></div>
            <p>{t(lang, 'form.volunteer')}</p>
          </li>
          <li>
            <div class="get-invovled-icon"><SpeakerHigh /></div>
            <p>{t(lang, 'form.advocate')}</p>
          </li>
          <li>
            <div class="get-invovled-icon"><Chat /></div>
            <p>{t(lang, 'form.stories')}</p>
          </li>
        </ul>
      </div>

      <form
        class="newsletter-form"
        onsubmit="submitYourMessage(event)"
        novalidate
      >
        <fieldset>
          <legend class="sr-only">{t(lang, 'form.newsletterSignup')}</legend>

          <div class="form-row">
            <mdc-input
              id="first-name"
              name="firstName"
              label={t(lang, 'form.firstName')}
              placeholder={t(lang, 'form.firstNamePlaceholder')}
              autocomplete="given-name"
              required></mdc-input>

            <mdc-input
              id="last-name"
              name="lastName"
              label={t(lang, 'form.lastName')}
              placeholder={t(lang, 'form.lastNamePlaceholder')}
              autocomplete="family-name"
              required></mdc-input>
          </div>

          <mdc-input
            id="email"
            name="email"
            type="email"
            label={t(lang, 'form.emailAddress')}
            placeholder={t(lang, 'form.emailPlaceholder')}
            autocomplete="email"
            required></mdc-input>

          <mdc-textarea
            id="message"
            name="message"
            label={t(lang, 'form.message')}
            placeholder={t(lang, 'form.messagePlaceholder')}
            wrap="soft"
            cols="170"
            required
            autocapitalize="off"
            autocomplete="off"></mdc-textarea>

          <mdc-button type="submit" variant="primary" size="40">
            {t(lang, 'form.submit')}
          </mdc-button>
        </fieldset>
      </form>
    </div>
    {
      urlSuffix === 'contact' && (
        <Image
          class="image"
          src={ContactImage}
          alt={t(lang, 'form.imageAlt')}
        />
      )
    }
  </div>
</div>

<style>
  .flex-container {
    display: flex;
    gap: 2rem;
    align-items: flex-start;
    justify-content: center;
    padding: 0;
  }

  .contact-form {
    flex-grow: 1;
  }
  .image {
    width: 50%;
  }

  /* Banner Styles */
  .banner {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem 1.5rem;
    border-radius: 0.5rem;
    margin-bottom: 1.5rem;
    border: 1px solid;
    font-size: 1rem;
    line-height: 1.5;
    animation: slideDown 0.3s ease-out;
  }

  @keyframes slideDown {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .banner-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 1.5rem;
    height: 1.5rem;
    font-size: 1.25rem;
    font-weight: bold;
    flex-shrink: 0;
  }

  .banner-content {
    flex: 1;
  }

  .banner-text {
    display: block;
    font-weight: 500;
  }

  .banner-success {
    background-color: var(--mds-color-theme-background-success-normal, #d4edda);
    border-color: var(--mds-color-theme-outline-success-normal, #28a745);
    color: var(--mds-color-theme-text-success-normal, #155724);
  }

  .banner-success .banner-icon {
    color: var(--mds-color-theme-text-success-normal, #155724);
  }

  .banner-error {
    background-color: var(--mds-color-theme-background-error-normal, #f8d7da);
    border-color: var(--mds-color-theme-outline-error-normal, #dc3545);
    color: var(--mds-color-theme-text-error-normal, #721c24);
  }

  .banner-error .banner-icon {
    color: var(--mds-color-theme-text-error-normal, #721c24);
  }

  @media screen and (max-width: 576px) {
    .flex-container {
      flex-direction: column;
      align-items: center;
    }
    .image {
      width: 100%;
    }

    .banner {
      padding: 0.875rem 1rem;
      font-size: 0.9375rem;
    }

    .banner-icon {
      width: 1.25rem;
      height: 1.25rem;
      font-size: 1rem;
    }
  }
</style>
<script>
  import('@momentum-design/components/dist/components/button/index.js');
  import('@momentum-design/components/dist/components/input/index.js');
  import('@momentum-design/components/dist/components/icon/index.js');
  import('@momentum-design/components/dist/components/text/index.js');
  import('@momentum-design/components/dist/components/textarea/index.js');

  async function submitYourMessage(event: Event) {
    event.preventDefault();

    let isValid = true;

    // Get form elements
    const firstNameInput = document.getElementById(
      'first-name'
    ) as HTMLInputElement;
    const lastNameInput = document.getElementById(
      'last-name'
    ) as HTMLInputElement;
    const emailInput = document.getElementById('email') as HTMLInputElement;
    const messageTextarea = document.getElementById(
      'message'
    ) as HTMLInputElement;
    const successBanner = document.getElementById(
      'success-banner'
    ) as HTMLElement;
    const errorBanner = document.getElementById('error-banner') as HTMLElement;
    const errorMessage = document.getElementById(
      'error-message'
    ) as HTMLElement;

    // Hide banners at the start
    if (successBanner) successBanner.style.display = 'none';
    if (errorBanner) errorBanner.style.display = 'none';

    // Reset error states
    [firstNameInput, lastNameInput, emailInput, messageTextarea].forEach(
      (element) => {
        if (element) {
          element.removeAttribute('help-text');
          element.removeAttribute('help-text-type');
        }
      }
    );

    // Validate first name
    if (!firstNameInput?.value || firstNameInput.value.trim() === '') {
      firstNameInput.setAttribute('help-text', 'First name is required');
      firstNameInput.setAttribute('help-text-type', 'error');
      isValid = false;
    }

    // Validate last name
    if (!lastNameInput?.value || lastNameInput.value.trim() === '') {
      lastNameInput.setAttribute('help-text', 'Last name is required');
      lastNameInput.setAttribute('help-text-type', 'error');
      isValid = false;
    }

    // Validate email
    if (!emailInput?.value || emailInput.value.trim() === '') {
      emailInput.setAttribute('help-text', 'Email address is required');
      emailInput.setAttribute('help-text-type', 'error');
      isValid = false;
    } else {
      // Validate email format
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(emailInput.value.trim())) {
        emailInput.setAttribute(
          'help-text',
          'Please enter a valid email address'
        );
        emailInput.setAttribute('help-text-type', 'error');
        isValid = false;
      }
    }

    // Validate message
    if (!messageTextarea?.value || messageTextarea.value.trim() === '') {
      messageTextarea.setAttribute('help-text', 'Message is required');
      messageTextarea.setAttribute('help-text-type', 'error');
      isValid = false;
    }

    // If all validations pass, submit the form
    if (isValid) {
      const submitButton = (event.target as HTMLFormElement).querySelector(
        'mdc-button[type="submit"]'
      ) as HTMLButtonElement;

      // Disable the submit button and show loading state
      if (submitButton) {
        submitButton.setAttribute('disabled', 'true');
        const originalText = submitButton.textContent;
        submitButton.textContent = 'Sending...';

        try {
          // Send form data to API endpoint
          // Use environment variable for API URL (Vercel deployment)
          const apiUrl =
            import.meta.env.PUBLIC_API_URL ||
            'https://your-project.vercel.app/api/contact';
          const response = await fetch(apiUrl, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              firstName: firstNameInput.value,
              lastName: lastNameInput.value,
              email: emailInput.value,
              message: messageTextarea.value,
            }),
          });

          const result = await response.json();

          if (result.success) {
            // Show success banner
            if (successBanner) {
              successBanner.style.display = 'flex';
              // Scroll to banner
              successBanner.scrollIntoView({
                behavior: 'smooth',
                block: 'center',
              });
            }

            // Reset the form after successful submission
            (event.target as HTMLFormElement).reset();
          } else {
            console.error('Failed to send email:', result);

            // Show error banner
            if (errorBanner && errorMessage) {
              errorMessage.textContent =
                result.message || 'Failed to send message. Please try again.';
              errorBanner.style.display = 'flex';
              // Scroll to banner
              errorBanner.scrollIntoView({
                behavior: 'smooth',
                block: 'center',
              });
            }
          }
        } catch (error) {
          console.error('Error submitting form:', error);

          // Show error banner
          if (errorBanner && errorMessage) {
            const errorMsg =
              error instanceof Error
                ? error.message
                : 'An error occurred. Please try again later.';
            errorMessage.textContent = errorMsg;
            errorBanner.style.display = 'flex';
            // Scroll to banner
            errorBanner.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }
        } finally {
          // Re-enable the submit button
          if (submitButton) {
            submitButton.removeAttribute('disabled');
            submitButton.textContent = originalText;
          }
        }
      }
    }

    return false;
  }

  // Make function available globally
  (window as any).submitYourMessage = submitYourMessage;
</script>
