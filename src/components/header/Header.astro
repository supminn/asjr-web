---
// Header.astro - Main navigation header using Momentum Design app header
import './Header.css';

import { Image } from 'astro:assets';
import LogoASJR from '../../assets/images/header/logo-desktop.svg';
import { t, type Lang } from '../../i18n/get';

export interface Props {
  class?: string;
  lang?: 'en' | 'es';
}

// Get current path and detect language based on leading segment
const currentPath = Astro.url.pathname;
const baseUrl = import.meta.env.BASE_URL;

// Remove baseUrl to get relative path for language detection
const relativePath = currentPath.startsWith(baseUrl)
  ? currentPath.slice(baseUrl.length)
  : currentPath;

const inferredLang: 'en' | 'es' =
  relativePath.startsWith('es/') || relativePath.startsWith('es') ? 'es' : 'en';

const { class: className = '', lang = inferredLang } = Astro.props as Props;

const isSpanish = lang === 'es';

// Helper to strip or add /es prefix for counterpart navigation
function computeCounterpart(path: string) {
  const relPath = path.startsWith(baseUrl) ? path.slice(baseUrl.length) : path;
  const isEs = relPath.startsWith('es/') || relPath.startsWith('es');

  let newRelPath;
  if (isEs) {
    newRelPath = relPath.replace(/^es\/?/, '') || '';
  } else {
    newRelPath = relPath ? `es/${relPath}` : 'es/';
  }

  return `${baseUrl}${newRelPath}`;
}
const counterpartPath = computeCounterpart(currentPath);

// Navigation items (translated labels)
const navItems = [
  { key: 'nav.home', href: `${baseUrl}${isSpanish ? 'es/' : ''}` },
  { key: 'nav.about', href: `${baseUrl}${isSpanish ? 'es/' : ''}about` },
  {
    key: 'nav.ourWork',
    href: `${baseUrl}${isSpanish ? 'es/' : ''}our-work`,
  },
  {
    key: 'nav.resources',
    href: `${baseUrl}${isSpanish ? 'es/' : ''}resources`,
  },
  {
    key: 'nav.latestUpdates',
    href: `${baseUrl}${isSpanish ? 'es/' : ''}latest-updates`,
  },
  {
    key: 'nav.contact',
    href: `${baseUrl}${isSpanish ? 'es/' : ''}contact`,
  },
];

const seekHelpLink = `${baseUrl}${isSpanish ? 'es/' : ''}resources`;
const homePageLink = `${baseUrl}${isSpanish ? 'es/' : ''}`;

// Helper function to check if a nav item is the current page
function isCurrentPage(href: string): boolean {
  // Normalize both paths for comparison
  const normalizedCurrent = relativePath.endsWith('/')
    ? relativePath.slice(0, -1)
    : relativePath;
  const normalizedHref = href.startsWith(baseUrl)
    ? href.slice(baseUrl.length)
    : href;
  const normalizedHrefClean =
    normalizedHref.endsWith('/') && normalizedHref.length > 1
      ? normalizedHref.slice(0, -1)
      : normalizedHref;

  // Special case for home page
  if (normalizedHrefClean === '' || normalizedHrefClean === 'es') {
    return normalizedCurrent === '' || normalizedCurrent === 'es';
  }

  return normalizedCurrent === normalizedHrefClean;
}
---

<script>
  // Import Momentum icon component
  import '@momentum-design/components/dist/components/icon/index.js';
  import '@momentum-design/components/dist/components/toggle/index.js';
  import '@momentum-design/components/dist/components/buttonlink/index.js';
</script>

<header data-base-url={baseUrl}>
  <nav class="nav-container">
    <a href={homePageLink} class="nav-logo">
      <Image src={LogoASJR} alt={t(lang, 'logo.altText')} />
    </a>

    <div class="nav-container-right">
      <div class="nav-localization-toggle">
        <div role="switch" aria-checked="false" tabindex="0">          
          <span class="switch">
            <span></span>
          </span>
          <span class="on" aria-hidden="true">{t(lang, 'toggle.on')}</span>
          <span class="off" aria-hidden="true">{t(lang, 'toggle.off')}</span>
          <span class="label">{t('en', 'toggle.toSpanish')}</span>
        </div>
      </div>

      <button class="menu-icon" aria-label="{t(lang, 'nav.openMenu')}" data-open-label={t(lang, 'nav.openMenu')} data-close-label={t(lang, 'nav.closeMenu')} aria-expanded="false">
        <div class="list-icon">
          <span></span>
          <span></span>
          <span></span>
        </div>
        <div class="x-icon" style="display: none;"></div>
      </button>

      <ul class="nav-menu">
        {
          navItems.map((item) => (
            <li>
              <a
                href={item.href}
                class={isCurrentPage(item.href) ? 'active' : ''}
              >
                <span>{t(lang, item.key)}</span>
              </a>
            </li>
          ))
        }
      </ul>
    </div>
  </nav>

  <!-- Seek Help CTA -->
  <div class="section-seek-help accent">
    <div class="inner-container-seek-help seek-help-cta">
      <div class="content-horizontal">
        {t(lang, 'banner.question')}
        <mdc-buttonlink
          size="32"
          href={seekHelpLink}
          rel="noopener noreferrer"
        >
          {t(lang, 'banner.cta')}
        </mdc-buttonlink>
      </div>
    </div>
  </div>
</header>

<script>
  (() => {
    const menuIcon = document.querySelector('.menu-icon') as HTMLElement | null;
    const listIcon = document.querySelector('.list-icon') as HTMLElement | null;
    const xIcon = document.querySelector('.x-icon') as HTMLElement | null;
    const navMenu = document.querySelector('.nav-menu') as HTMLElement | null;
    const navLinks = document.querySelectorAll('.nav-menu li a');
    const langToggle = document.querySelector(
      'mdc-toggle[name="lang-toggle"]'
    ) as HTMLElement | null;

    // Language toggle navigation
    if (langToggle) {
      // Ensure toggle state reflects current language on page load
      const header = document.querySelector('header');
      const baseUrl = header?.getAttribute('data-base-url') || '/';
      const current = window.location.pathname;
      const relativePath = current.startsWith(baseUrl)
        ? current.slice(baseUrl.length)
        : current;
      const isSpanish =
        relativePath.startsWith('es/') || relativePath.startsWith('es');

      // Set checked state explicitly after component loads
      if (isSpanish) {
        langToggle.setAttribute('checked', 'true');
      } else {
        langToggle.removeAttribute('checked');
      }

      langToggle.addEventListener('click', () => {
        console.log('Toggle Click');
        // Check current state before navigation
        const curr = window.location.pathname;
        const relPath = curr.startsWith(baseUrl)
          ? curr.slice(baseUrl.length)
          : curr;
        const isEs = relPath.startsWith('es/') || relPath.startsWith('es');

        let newPath;
        if (isEs) {
          // Going to English: remove 'es/' prefix
          newPath = relPath.replace(/^es\/?/, '') || '';
        } else {
          // Going to Spanish: add 'es/' prefix
          newPath = relPath ? `es/${relPath}` : 'es/';
        }

        // Construct final URL with baseUrl
        const target = `${baseUrl}${newPath}`;
        window.location.href = target;
      });
    }

    if (!menuIcon || !listIcon || !xIcon || !navMenu) return;

    //Mobile Resonsive Menu
    menuIcon.addEventListener('click', () => {
      const isExpanded = menuIcon.getAttribute('aria-expanded') === 'true';
      menuIcon.setAttribute('aria-expanded', (!isExpanded).toString());
      menuIcon.classList.toggle('active');
      navMenu.classList.toggle('active');
      navMenu.style.display = !isExpanded ? 'flex' : '';
      if (!isExpanded) {
        listIcon.style.display = 'none';
        xIcon.style.display = 'block';
      } else {
        listIcon.style.display = 'flex';
        xIcon.style.display = 'none';
      }
      menuIcon.setAttribute(
        'aria-label',
        !isExpanded ? menuIcon.dataset.closeLabel : menuIcon.dataset.openLabel
      );
    });

    navLinks.forEach((link) => {
      link.addEventListener('click', () => {
        menuIcon.setAttribute('aria-expanded', 'false');
        menuIcon.classList.remove('active');
        navMenu.classList.remove('active');
        navMenu.style.display = '';
        listIcon.style.display = 'flex';
        xIcon.style.display = 'none';
        menuIcon.setAttribute('aria-label', menuIcon.dataset.openLabel);
      });
    });

    window.addEventListener('resize', () => {
      const isExpanded = menuIcon.getAttribute('aria-expanded') === 'true';
      if (isExpanded) {
        menuIcon.setAttribute('aria-expanded', 'false');
        menuIcon.classList.remove('active');
        navMenu.classList.remove('active');
        navMenu.style.display = '';
        listIcon.style.display = 'flex';
        xIcon.style.display = 'none';
        menuIcon.setAttribute('aria-label', menuIcon.dataset.openLabel);
      }
    });
  })();

  /*
 *   This content is licensed according to the W3C Software License at
 *   https://www.w3.org/Consortium/Legal/2015/copyright-software-and-document
 *
 *   File:  switch.js
 *
 *   Desc:  Switch widget that implements ARIA Authoring Practices
 */

'use strict';

class Switch {
  constructor(domNode) {
    this.switchNode = domNode;
    this.switchNode.addEventListener('click', () => this.toggleStatus());
    this.switchNode.addEventListener('keydown', (event) =>
      this.handleKeydown(event)
    );
    
    // Set initial state based on current language
    this.initializeState();
  }
  
  initializeState() {
    const header = document.querySelector('header');
    const baseUrl = header?.getAttribute('data-base-url') || '/';
    const current = window.location.pathname;
    const relativePath = current.startsWith(baseUrl)
      ? current.slice(baseUrl.length)
      : current;
    const isSpanish =
      relativePath.startsWith('es/') || relativePath.startsWith('es');

    // Set checked state to match current language
    this.switchNode.setAttribute('aria-checked', isSpanish ? 'true' : 'false');
  }

  handleKeydown(event) {
    // Only do something when space or return is pressed
    if (event.key === 'Enter' || event.key === ' ') {
      event.preventDefault();
      this.toggleStatus();
    }
  }

  // Switch state of a switch
  toggleStatus() {
    const currentState =
      this.switchNode.getAttribute('aria-checked') === 'true';
    const newState = String(!currentState);

    this.switchNode.setAttribute('aria-checked', newState);

    // Get base URL from header
    const header = document.querySelector('header');
    const baseUrl = header?.getAttribute('data-base-url') || '/';
    
    // Check current state before navigation
    const curr = window.location.pathname;
    const relPath = curr.startsWith(baseUrl)
      ? curr.slice(baseUrl.length)
      : curr;
    const isEs = relPath.startsWith('es/') || relPath.startsWith('es');

    let newPath;
    if (currentState) {
      // Switch is currently ON (Spanish), turning OFF to go to English
      // Remove 'es/' prefix
      newPath = relPath.replace(/^es\/?/, '') || '';
    } else {
      // Switch is currently OFF (English), turning ON to go to Spanish
      // Add 'es/' prefix
      newPath = relPath ? `es/${relPath}` : 'es/';
    }

    // Construct final URL with baseUrl
    const target = `${baseUrl}${newPath}`;
    window.location.href = target;
  }
}

// Initialize switches
window.addEventListener('load', function () {
  // Initialize the Switch component on all matching DOM nodes
  Array.from(document.querySelectorAll('[role^=switch]')).forEach(
    (element) => new Switch(element)
  );
});
</script>
